---
title: "Final Project"
output: pdf_document
date: "2024-04-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(summarytools)
library(corrplot)
library(gt)
library(caret)
```

## Loading the Data

```{r}
stroke <- read.csv("https://raw.githubusercontent.com/Mattr5541/DATA-621-Final-Project/main/621clean_shout_dat(in).csv")
```

## Data Cleaning

First, I will code all "Unknown" observations as NA, as their presence may confound our analysis

```{r}
stroke <- stroke %>% mutate(across(where(is.character), ~na_if(., "Unknown")))
stroke <- stroke %>% mutate(across(where(is.character), ~na_if(., "Unknown or Not Reported")))
```

## Recoding NA values with N where applicable

Certain variables were not coded with N where the presence of an outcome was false. This can be seen in variables with only one outcome

```{r}
#unique_values <- lapply(stroke, unique)
#print(unique_values)

stroke <- stroke %>% 
  mutate(
    CovidAtVisitFlag = replace_na(CovidAtVisitFlag, 'N'),
    FamilyHistoryStrokeFlag = replace_na(FamilyHistoryStrokeFlag, 'N'),
    prior.COVID.19 = replace_na(prior.COVID.19, 'N'),
    hypertension = replace_na(hypertension, 'N'),
    diabetes.mellitus = replace_na(diabetes.mellitus, 'N'),
    diabetes.mellitus.type.2 = replace_na(diabetes.mellitus.type.2, 'N'),
    myocardial.infarction = replace_na(myocardial.infarction, 'N'),
    alzheimer.s.disease = replace_na(alzheimer.s.disease, 'N'),
    hyperlipidemia = replace_na(hyperlipidemia, 'N'),
    atrial.fibrillation = replace_na(atrial.fibrillation, 'N'),
    chronic.heart.disease = replace_na(chronic.heart.disease, 'N'),
    chronic.kidney.disease = replace_na(chronic.kidney.disease, 'N'),
    carotid.stenosis = replace_na(carotid.stenosis, 'N'),
    Coronary.artery.disease = replace_na(Coronary.artery.disease, 'N'),
    Heart.failure = replace_na(Heart.failure, 'N'),
    Peripheral.vascular.disease = replace_na(Peripheral.vascular.disease, 'N'),
    Dysphagia_outcome = replace_na(Dysphagia_outcome, 'N'),
    ispregnancyDoc = replace_na(ispregnancyDoc, 'N'), 
    ispregnancyICD = replace_na(ispregnancyICD, 'N'),
    isTransferEvent = replace_na(isTransferEvent, 'N'))
```


### Examining Missingness

My next step wil be to remove columns that present 80% or more missingness, as they will likely not contribute to our analyses, and any attempts to impute values for these columns may generate unreliable data (we may have to consider the same for columns that present 50% or more missing values)

```{r}
miss_percent <- colSums(is.na(stroke) / 29662 * 100)

miss_percent_80 <- as.data.frame(miss_percent)

miss_percent_80 <- miss_percent_80 %>% filter(miss_percent > 79)

print(miss_percent_80)
```

## Exploratory Data Analysis

```{r}
stroke <- stroke %>% 
  select(-alcohol_use_frequency, -evt, -evt_status, -tici_score)

```

## Splitting the Data into Training/Test Sets

Before modifying the dataset any further, I will split the data into train/test partitions for the purposes of model validation (I will use a standard 80/20 split. To start, however, I want to see how evenly the binary outcomes of our target variable occur in our dataset (I'm assuming there will be an uneven split that is more biased toward negative outcomes)

```{r}
table(stroke$TARGET)
```

As expected, there is a bias toward negative outcomes, presenting the issue of imbalance in our data. As a result, we may need to perform an oversampling or undersampling procedure to account for this, or otherwise balance observations while constructing our models.

```{r}
set.seed(12345)

train_test <- createDataPartition(stroke$TARGET, p = 0.8, list = F)

stroke_train <- stroke[train_test, ]
stroke_test <- stroke[-train_test, ]
```

## Exploratory Data Analysis

### Frequencies

```{r}
stroke_train_cat <- select_if(stroke_train, is.character)

stroke_freq <- dfSummary(stroke_train_cat, stats = 'freq')

view(stroke_freq)
```

### Descriptive Statistics

```{r}
stroke_train_quant <- select_if(stroke_train, is.numeric)

stroke_train_quant <- stroke_train_quant %>% select(-IsIschaemicStrokeEvent) #Removing because the only value is 1

stroke_sum <- dfSummary(stroke_train_quant, stats = c("mean", "sd", "med", "IQR", "min", "max", "valid", "n.missing"))

view(stroke_sum)
```

### Correlation Matrix

```{r}
cor_matrix = cor(stroke_train_quant, use = "complete.obs")

print(cor_matrix)

corrplot(cor_matrix, method = "circle", type = "upper", order = "hclust",
         tl.col = "black", tl.srt = 45, 
         addCoef.col = "black")
```

As we can see, most of the correlations present are rather weak. The exception would be the correlations among Arrival_NHISS_score and the cleaned version (I will drop the original), and some moderate correlations among MRS_discharge_score_cleaned and the NHISS scores. Aside from that, there seems to be no real concern regarding multicollinearity among these variables.

Interestingly, there seem to be no high correlations among the predictors and target variables, suggesting that our features may be weak predictors, by themselves, of recurrent strokes, which is rather interesting, since these factors should intuitively be related to the presence of recurrent strokes.

```{r}
stroke_train <- stroke_train %>% select(-Arrival_NIHSS_score)
stroke_test <- stroke_test %>% select(-Arrival_NIHSS_score)
```

#Part 2
## Missing data

```{r}
missing_percentage <- stroke_train %>%
  summarise_all(~ mean(is.na(.)) * 100)

print(missing_percentage)
```

The following variables have missing data. I broke them up based on the type and provided the percent of missing data to inform the best method to impute the missing data.

Continuous Variables:
Length_of_stay_hours (<1%), MRS_discharge_score_cleaned (14%),
Arrival_NIHSS_score_cleaned (25%), BMI(18.7%). These variables are not normally distributed so I will use median imputation

Categorical or Ordinal Variables: Race, Ethnicity, Gender, Arrival_mode, Arrival_from, Discharge_disposition, Visit_data_dispo, Tobacco_current_use_indicator, Tobacco_prior_use_indicator, InsuranceCategory, Discharge_disposition_regex. To preserve the nature of these variables, I will use mode imputation as it replaces missing values with the most frequent category. 

```{r}
mode_impute <- function(x) {
  mode_val <- names(sort(table(x), decreasing = TRUE))[1]
  x[is.na(x)] <- mode_val
  return(x)
}

columns_to_impute <- c("race", "ethnicity", "gender", "arrival_mode", "arrival_from", "discharge_disposition", "visit_data_dispo", "Tobacco_current_use_indicator", "Tobacco_prior_use_indicator", "InsuranceCategory", "discharge_disposition_regex")

stroke_train <- stroke_train %>%
  mutate_at(.vars = columns_to_impute, .funs = mode_impute)

stroke_train$MRS_discharge_score_cleaned <- median(stroke_train$MRS_discharge_score_cleaned, na.rm = TRUE)
stroke_train$Arrival_NIHSS_score_cleaned <- median(stroke_train$Arrival_NIHSS_score_cleaned, na.rm = TRUE)
stroke_train$Length_of_stay_hours <- median(stroke_train$Length_of_stay_hours, na.rm = TRUE)
stroke_train$BMI <- median(stroke_train$BMI, na.rm = TRUE)
```

Now there is no missing data in stroke_train dataset

```{r}
missing_data_report = stroke_train %>%
  summarise_all(~sum(is.na(.)))

print(missing_data_report)
```



```{r}
#imputing testing dataset
mode_impute <- function(x) {
  mode_val <- names(sort(table(x), decreasing = TRUE))[1]
  x[is.na(x)] <- mode_val
  return(x)
}
columns_to_impute <- c("race", "ethnicity", "gender", "arrival_mode", "arrival_from", "discharge_disposition", "visit_data_dispo", "Tobacco_current_use_indicator", "Tobacco_prior_use_indicator", "InsuranceCategory", "discharge_disposition_regex")

stroke_test <- stroke_test %>%
  mutate_at(.vars = columns_to_impute, .funs = mode_impute)

stroke_test$MRS_discharge_score_cleaned <- ifelse(is.na(stroke_test$MRS_discharge_score_cleaned), median(stroke_test$MRS_discharge_score_cleaned, na.rm = TRUE), stroke_test$MRS_discharge_score_cleaned)
stroke_test$Arrival_NIHSS_score_cleaned <- ifelse(is.na(stroke_test$Arrival_NIHSS_score_cleaned), median(stroke_test$Arrival_NIHSS_score_cleaned, na.rm = TRUE), stroke_test$Arrival_NIHSS_score_cleaned)
stroke_test$Length_of_stay_hours <- ifelse(is.na(stroke_test$Length_of_stay_hours), median(stroke_test$Length_of_stay_hours, na.rm = TRUE), stroke_test$Length_of_stay_hours)
stroke_test$BMI <- ifelse(is.na(stroke_test$BMI), median(stroke_test$BMI, na.rm = TRUE), stroke_test$BMI)
```

```{r}
missing_data_test = stroke_test%>%
  summarise_all(~sum(is.na(.)))

print(missing_data_test)
```

###Dummy Coding Categorical Variables

Creating dummy coding for categorical variables, in both training and testing datasets, results in a format that helps prepare data for further analysis. The '-1' part of the code was done to avoid multicollinearity issues.

```{r}
#Train Dataset
stroke_train$dummy_race_train <- model.matrix(~race - 1, data = stroke_train)
stroke_train$dummy_eth_train <- model.matrix(~ethnicity- 1, data = stroke_train, na.action = na.pass)
stroke_train$dummy_gender_train <- model.matrix(~gender- 1, data = stroke_train)
stroke_train$dummy_vit_train <- model.matrix(~vital_status- 1, data = stroke_train)
stroke_train$dummy_age_train <- model.matrix(~age_group- 1, data = stroke_train)
stroke_train$dummy_visit_train <- model.matrix(~visit_type- 1, data = stroke_train)
stroke_train$dummy_tobacco_curr_train <- model.matrix(~Tobacco_current_use_indicator- 1, data = stroke_train)
stroke_train$dummy_tobacco_past_train <- model.matrix(~Tobacco_prior_use_indicator- 1, data = stroke_train)
stroke_train$dummy_fam_train <- model.matrix(~FamilyHistoryStrokeFlag- 1, data = stroke_train)
stroke_train$dummy_hypertension_train <- model.matrix(~hypertension- 1, data = stroke_train)
stroke_train$dummy_diabetes_1_train <- model.matrix(~diabetes.mellitus- 1, data = stroke_train)
stroke_train$dummy_diabetes_2_train <- model.matrix(~diabetes.mellitus.type.2- 1, data = stroke_train)
stroke_train$dummy_myo_train <- model.matrix(~myocardial.infarction- 1, data = stroke_train)
stroke_train$dummy_hyperlipidemia_train <- model.matrix(~hyperlipidemia- 1, data = stroke_train)
stroke_train$dummy_atrial_fib_train <- model.matrix(~atrial.fibrillation- 1, data = stroke_train)
stroke_train$dummy_heart_disease_train <- model.matrix(~chronic.heart.disease- 1, data = stroke_train)
stroke_train$dummy_kidney_train <- model.matrix(~chronic.kidney.disease- 1, data = stroke_train)
stroke_train$dummy_coronary_train <- model.matrix(~Coronary.artery.disease- 1, data = stroke_train)
stroke_train$dummy_heart_fail_train <- model.matrix(~Heart.failure- 1, data = stroke_train)
stroke_train$dummy_dysphagia_train <- model.matrix(~Dysphagia_outcome- 1, data = stroke_train)
stroke_train$dummy_heart_fail_train <- model.matrix(~Heart.failure- 1, data = stroke_train)
stroke_train$dummy_isTransferEvent_train <- model.matrix(~isTransferEvent- 1, data = stroke_train)
stroke_train$dummy_heart_fail_train <- model.matrix(~Heart.failure- 1, data = stroke_train)

#Test Dataset
stroke_test$dummy_race_test <- model.matrix(~race - 1, data = stroke_test)
stroke_test$dummy_eth_test <- model.matrix(~ethnicity- 1, data = stroke_test, na.action = na.pass)
stroke_test$dummy_gender_test <- model.matrix(~gender- 1, data = stroke_test)
stroke_test$dummy_vit_test <- model.matrix(~vital_status- 1, data = stroke_test)
stroke_test$dummy_age_test <- model.matrix(~age_group- 1, data = stroke_test)
 dummy_visit_test <- model.matrix(~visit_type- 1, data = stroke_test)
stroke_test$dummy_tobacco_curr_test <- model.matrix(~Tobacco_current_use_indicator- 1, data = stroke_test)
stroke_test$dummy_tobacco_past_test <- model.matrix(~Tobacco_prior_use_indicator- 1, data = stroke_test)
stroke_test$dummy_fam_test <- model.matrix(~FamilyHistoryStrokeFlag- 1, data = stroke_test)
stroke_test$dummy_hypertension_test <- model.matrix(~hypertension- 1, data = stroke_test)
stroke_test$dummy_diabetes_1_test <- model.matrix(~diabetes.mellitus- 1, data = stroke_test)
stroke_test$dummy_diabetes_2_test <- model.matrix(~diabetes.mellitus.type.2- 1, data = stroke_test)
stroke_test$dummy_myo_test <- model.matrix(~myocardial.infarction- 1, data = stroke_test)
stroke_test$dummy_hyperlipidemia_test <- model.matrix(~hyperlipidemia- 1, data = stroke_test)
stroke_test$dummy_atrial_fib_test <- model.matrix(~atrial.fibrillation- 1, data = stroke_test)
stroke_test$dummy_heart_disease_test <- model.matrix(~chronic.heart.disease- 1, data = stroke_test)
stroke_test$dummy_kidney_test <- model.matrix(~chronic.kidney.disease- 1, data = stroke_test)
stroke_test$dummy_coronary_test <- model.matrix(~Coronary.artery.disease- 1, data = stroke_test)
stroke_test$dummy_heart_fail_test <- model.matrix(~Heart.failure- 1, data = stroke_test)
stroke_test$dummy_dysphagia_test <- model.matrix(~Dysphagia_outcome- 1, data = stroke_test)
stroke_test$dummy_heart_fail_test <- model.matrix(~Heart.failure- 1, data = stroke_test)
stroke_test$dummy_isTransferEvent_test <- model.matrix(~isTransferEvent- 1, data = stroke_test)
stroke_test$dummy_heart_fail_test <- model.matrix(~Heart.failure- 1, data = stroke_test)
```

## Transformation (HELP!!) 

Log transformation on the variable BMI should prove to be helpful since the range of 2 to 259 is unrealistic in real world metrics (on both the higher and smaller end). The same transformation on Length_of_stay_hours would also be useful as there likely should not be negative hours nor 9,666 hours (max value) which estimates to over a year.

```{r}
log_no_neg <- function(x) {
  max_val <- max(x, na.rm = TRUE)
  min_val <- min(x, na.rm = TRUE)
  shift <- 0
  if (min_val <= 0) {
    shift <- abs(min_val) + 1
  }
  x_shifted <- x + shift
  log_x <- log(x_shifted)
  log_x[is.na(x)] <- NA  
  return(log_x)
}

stroke_train_1 <- stroke_train %>%
  mutate(
    log_BMI = log_no_neg(BMI),
    log_Length_of_stay_hours = log_no_neg(Length_of_stay_hours)
  ) %>%
  dplyr::select(-BMI, -Length_of_stay_hours)


train_stats <- dfSummary(stroke_train_1, stats = c("mean", "sd", "med", "IQR", "min", "max", "valid", "n.missing"))

view(train_stats)

#Both result in one distinct value which seems wrong
```
`
`
```{r}
# Apply log transformations safely by adding 1 to avoid log(0)
stroke_train <- stroke_train %>%
  mutate(log_BMI = log(BMI + 1),
         log_Length_of_stay_hours = log(Length_of_stay_hours + 1))

# Check the histograms of the log-transformed variables
par(mfrow=c(1,2))
hist(stroke_train$log_BMI, main = "Log-transformed BMI")
hist(stroke_train$log_Length_of_stay_hours, main = "Log-transformed Length_of_stay_hours")

#tried it again - same issue
```










